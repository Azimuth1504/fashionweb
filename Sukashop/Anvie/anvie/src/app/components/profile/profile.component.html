<main class="ps-page--my-account">
  <div class="ps-breadcrumb">
    <div class="container">
      <ul class="breadcrumb">
        <li><a [routerLink]="['/home']">Trang chủ</a></li>
        <li><a [routerLink]="['/profile']">Tài khoản</a></li>
        <li>Tài khoản cá nhân</li>
      </ul>
    </div>
  </div>
  <section class="ps-section--account">
    <div class="container">
      <div class="row">
        <div class="col-lg-3">
          <div class="ps-section__left">
            <aside class="ps-widget--account-dashboard">
              <div class="ps-widget__header">
                <img [src]="customer?.image || 'assets/img/default-avatar.png'" alt="Avatar"
                  style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #09c;" />
                <figure>
                  <p>
                    Tên: <span style="color: #09c">{{ customer?.name }}</span>
                  </p>
                  <p>
                    Tham gia:
                    <span>{{ customer?.registerDate | date : "dd-MM-yyy" }}</span>
                  </p>
                </figure>
              </div>
              <div class="ps-widget__content">
                <ul>
                  <li>
                    <a href="javascript:void(0);">
                      <i class="icon-user"></i>
                      <span>{{ customer?.email }}</span>
                    </a>
                    <a href="javascript:void(0);">
                      <i class="icon-papers"></i> {{ customer?.phone || 'Chưa cập nhật' }}
                    </a>
                    <a href="javascript:void(0);">
                      <i class="icon-user"></i>
                      {{ customer?.gender ? "Nam" : "Nữ" }}
                    </a>
                    <a href="javascript:void(0);">
                      <i class="icon-map-marker"></i> {{ customer?.address || 'Chưa cập nhật' }}
                    </a>
                    <a href="javascript:void(0);">
                      <i class="icon-store"></i>Đã giao dịch: {{ done || 0 }} đơn
                    </a>
                  </li>
                </ul>
                <!-- Edit Profile Button -->
                <div class="mt-3">
                  <button class="ps-btn ps-btn--sm ps-btn--fullwidth" (click)="openEditProfile()">
                    <i class="icon-pencil mr-2"></i>Sửa thông tin
                  </button>
                </div>
              </div>
            </aside>
          </div>
        </div>
        <div class="col-lg-9">
          <div class="ps-section__right">
            <div class="ps-section--account-setting">
              <div class="ps-section__header">
                <h3>Lịch sử đặt hàng</h3>
              </div>
              <div class="ps-section__content">
                <div class="table-responsive">
                  <table class="table ps-table ps-table--invoices">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Ngày đặt</th>
                        <th>Tổng tiền</th>
                        <th>Địa chỉ</th>
                        <th>Số điện thoại</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="
                          let item of orders
                            | paginate : { itemsPerPage: 5, currentPage: page };
                          index as i
                        ">
                        <td>{{ i + 1 }}</td>
                        <td style="width: 15%">
                          {{ item.orderDate | date : "dd-MM-yyyy" }}
                        </td>
                        <td>{{ item.amount | currency : "VND" }}</td>
                        <td>{{ item.address }}</td>
                        <td>{{ item.phone }}</td>
                        <td style="width: 17%">
                          <span class="status" [ngClass]="{
                                'status-pending': item.status == 0,
                                'status-shipping': item.status == 1,
                                'status-delivered': item.status == 2,
                                'status-cancelled': item.status == 3
                              }">
                            {{
                            item.status == 0
                            ? "Chờ xác nhận"
                            : item.status == 1
                            ? "Đã xác nhận"
                            : item.status == 2
                            ? "Đã thanh toán"
                            : "Đã huỷ"
                            }}
                          </span>
                        </td>
                        <td style="width: 5%">
                          <app-order-detail [id]="item.ordersId"></app-order-detail>
                          <a [title]="
                              item.status == 0
                                ? 'Huỷ đơn'
                                : 'Không thể huỷ đơn này'
                            " (click)="
                              cancel(item.status == 0 ? item.ordersId : -1)
                            " [style]="
                              item.status == 0
                                ? 'cursor: pointer'
                                : 'cursor: not-allowed'
                            " onMouseOver="this.style.color='white', this.style.backgroundColor='red'"
                            onMouseOut="this.style.color='red', this.style.backgroundColor='white'">
                            <i class="icon-cross"></i>
                          </a>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="row">
                    <div class="col-lg-12">
                      <ul>
                        <pagination-controls (pageChange)="page = $event" previousLabel="" nextLabel=""
                          class="text-center my-page">
                        </pagination-controls>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Newsletter Section -->
  <div class="ps-newsletter">
    <div class="container">
      <form class="ps-form--newsletter">
        <div class="row">
          <div class="col-xl-5 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="ps-form__left">
              <h3>Bản tin</h3>
              <p>Đăng ký để nhận thông tin về sản phẩm và phiếu giảm giá</p>
            </div>
          </div>
          <div class="col-xl-7 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="ps-form__right">
              <div class="form-group--nest">
                <input class="form-control" type="email" placeholder="Địa chỉ Email" />
                <button class="ps-btn">Gửi</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</main>

<!-- Edit Profile Modal -->
<ng-template #editProfileModal>
  <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h5 class="modal-title"><i class="icon-user mr-2"></i>Chỉnh sửa thông tin cá nhân</h5>
    <button type="button" class="close text-white" (click)="editModalRef.dismiss()">
      <span>&times;</span>
    </button>
  </div>
  <div class="modal-body" style="background: #f8f9fa;">
    <form [formGroup]="editForm">
      <div class="row">
        <!-- Avatar -->
        <div class="col-md-4 text-center mb-4">
          <div class="position-relative d-inline-block">
            <img [src]="previewImage || 'assets/img/default-avatar.png'" alt="Avatar"
              style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <input type="file" class="d-none" id="profileImage" (change)="onProfileImageSelect($event)"
              accept="image/*">
            <label for="profileImage" class="btn btn-primary btn-sm position-absolute"
              style="bottom: 5px; right: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
              [class.disabled]="isUploadingImage">
              <i *ngIf="!isUploadingImage" class="icon-camera"></i>
              <i *ngIf="isUploadingImage" class="fa fa-spinner fa-spin"></i>
            </label>
          </div>
          <p class="text-muted mt-2 small">Nhấn vào biểu tượng camera để đổi ảnh</p>
        </div>

        <!-- Form Fields -->
        <div class="col-md-8">
          <div class="form-group mb-3">
            <label class="font-weight-bold">Họ và tên <span class="text-danger">*</span></label>
            <input type="text" class="form-control" formControlName="name" placeholder="Nhập họ và tên">
            <small *ngIf="editForm.get('name')?.invalid && editForm.get('name')?.touched" class="text-danger">
              Họ tên phải có ít nhất 2 ký tự
            </small>
          </div>

          <div class="form-group mb-3">
            <label class="font-weight-bold">Số điện thoại <span class="text-danger">*</span></label>
            <input type="text" class="form-control" formControlName="phone" placeholder="VD: 0912345678">
            <small *ngIf="editForm.get('phone')?.invalid && editForm.get('phone')?.touched" class="text-danger">
              Số điện thoại phải có 10-11 chữ số
            </small>
          </div>

          <div class="form-group mb-3">
            <label class="font-weight-bold">Địa chỉ <span class="text-danger">*</span></label>
            <textarea class="form-control" formControlName="address" rows="2" placeholder="Nhập địa chỉ"></textarea>
            <small *ngIf="editForm.get('address')?.invalid && editForm.get('address')?.touched" class="text-danger">
              Vui lòng nhập địa chỉ
            </small>
          </div>

          <div class="form-group mb-3">
            <label class="font-weight-bold">Giới tính</label>
            <div class="d-flex">
              <div class="custom-control custom-radio mr-4">
                <input type="radio" id="genderMale" class="custom-control-input" formControlName="gender"
                  [value]="true">
                <label class="custom-control-label" for="genderMale">Nam</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="genderFemale" class="custom-control-input" formControlName="gender"
                  [value]="false">
                <label class="custom-control-label" for="genderFemale">Nữ</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer" style="background: #f8f9fa;">
    <button type="button" class="btn btn-outline-secondary" (click)="editModalRef.dismiss()">
      <i class="icon-cross mr-1"></i>Hủy
    </button>
    <button type="button" class="btn btn-primary" [disabled]="editForm.invalid || isEditing || isUploadingImage"
      (click)="saveProfile()">
      <i *ngIf="!isEditing" class="icon-checkmark mr-1"></i>
      <i *ngIf="isEditing" class="fa fa-spinner fa-spin mr-1"></i>
      {{ isEditing ? 'Đang lưu...' : 'Lưu thay đổi' }}
    </button>
  </div>
</ng-template>